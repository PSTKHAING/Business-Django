{% extends 'user/components/base.html' %}

{% block title %}Post Create{% endblock %}
{% load static %}
{% block body %}

<style>
    .media-preview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
    }

    .media-label {
        display: flex;
        justify-content: center;
        align-items: center;
        min-width: 100%;
        margin-top: 0.5rem;
    }

    .media-preview img,
    .media-preview video {
        width: 100%;
        height: 300px;
        object-fit: cover;
    }

    .media-preview div {
        position: relative;
        border-radius: 0.5rem;
        overflow: hidden;
        border: 1px solid #fff;
    }

    .media-preview button {
        padding: 1rem;
        bottom: 1px;
        left: 1px;
        background: red;
        border-top-right-radius: 2rem;
        color: #ffffff;
        position: absolute;
        cursor: pointer;
    }
</style>

<form action="/post/create/" method="POST" enctype="multipart/form-data"
    class="col-xxl-6 col-xl-5 col-lg-8 mt-0 mt-lg-10 mt-xl-0 d-flex flex-column gap-7 cus-z">
    <div class="share-post d-flex gap-3 gap-sm-5 p-3 p-sm-5">
        <div class="w-100 position-relative">
            {% csrf_token %}
            <textarea cols="10" name="content" class="resize-none" rows="10"
                placeholder="Write something {{user.username}}.."></textarea>
        </div>
    </div>
    <div class="file-upload">
        <label>Upload attachment</label>
        <label class="file mt-1">
            <input type="file" name="media" multiple accept="image/*,video/*" id="media"
                onchange="displayMediaPreview()">
            <span class="file-custom pt-8 pb-8 d-grid text-center">
                <i class="material-symbols-outlined mat-icon"> perm_media </i>
                <span>Drag here or click to upload photo.</span>
            </span>
        </label>
    </div>

    <!-- Display media preview -->
    <div id="media-preview" class="media-preview"></div>
    <button type="submit">Create</button>
</form>

<script>
    let removedFiles = [];  // To track removed files

    // Function to display the media preview
    function displayMediaPreview() {
        var fileInput = document.getElementById('media');
        var mediaPreviewContainer = document.getElementById('media-preview');

        Array.from(fileInput.files).forEach(file => {
            var fileReader = new FileReader();

            fileReader.onload = function (event) {
                var fileType = file.type.split('/')[0];  // 'image' or 'video'
                var fileUrl = event.target.result;
                var mediaElement = document.createElement(fileType === 'image' ? 'img' : 'video');
                mediaElement.src = fileUrl;
                if (fileType === 'video') mediaElement.controls = true;

                var removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.className = 'remove-media';
                removeButton.onclick = function () {
                    mediaPreviewContainer.removeChild(container);
                    removedFiles.push(file); // Track the removed file
                    updateFileInput();
                };

                // Create a new div for the file preview
                var container = document.createElement('div');
                container.classList.add('media-container');  // Add class for styling
                container.appendChild(mediaElement);
                container.appendChild(removeButton);

                // Append the container to the media preview container
                mediaPreviewContainer.appendChild(container);
            };

            fileReader.readAsDataURL(file);
        });
    }

    // Function to update the file input to exclude removed files
    function updateFileInput() {
        var fileInput = document.getElementById('media');
        var newFiles = Array.from(fileInput.files).filter(file => !removedFiles.includes(file));  // Remove the removed files
        var dataTransfer = new DataTransfer(); // Create a new DataTransfer object to hold the updated files

        newFiles.forEach(file => {
            dataTransfer.items.add(file); // Add non-removed files
        });

        fileInput.files = dataTransfer.files; // Update the file input with the new file list
    }
</script>

{% endblock %}